
<html>

    <head>
        <meta charset="UTF-8">
        <title>手速练习器</title>
    </head>
    
    <body style="background-image: url(https://teacher.solid.things.ac.cn:7243/public/student_data/2019k8009970015/web/3f5ed2ed21939f9e00ea81f474dd8d4b.jpg);
    background-size: 100% 100%; background-attachment: fixed">
        <h1 id="title_1" align="center">小热身：(⊙﹏⊙) 网页好像出了点问题，请连按‘F’加载</h1>
        <table width="100%" align="center" border="0" cellspacing="1">
            <tr style="height: 20px">
                <td id="progress1"></td> <td id="progress2"></td> <td id="progress3"></td> <td id="progress4"></td> <td id="progress5"></td>
                <td id="progress6"></td> <td id="progress7"></td> <td id="progress8"></td> <td id="progress9"></td> <td id="progress10"></td>
                <td id="progress11"></td> <td id="progress12"></td> <td id="progress13"></td> <td id="progress14"></td> <td id="progress15"></td>
                <td id="progress16"></td> <td id="progress17"></td> <td id="progress18"></td> <td id="progress19"></td> <td id="progress20"></td>
                <td id="progress21"></td> <td id="progress22"></td> <td id="progress23"></td> <td id="progress24"></td> <td id="progress25"></td>
                <td id="progress26"></td> <td id="progress27"></td> <td id="progress28"></td> <td id="progress29"></td>
            </tr>
        </table>
        <p id="loading_perctage" align="center">提示：为确保网页正常浏览，请用电脑端chrome打开并不要缩放。</p>
    
        <div id="game" align="center" style="display: none; background-color: rgba(255,255,255,0.5); 
        width: 85%; height: 150%; margin: 0 auto;">
            <h2 style="color:tomato"><i>热身完成！</i></h2>
            <h2>小游戏：手速测试</h2>
            <p>点击“开始”后，下侧方框中将依次出现随机字母，你需要及时按下键盘相应按键。
                若按错或漏过则游戏结束。
                <br>为便于辨别，字母将以“黑-灰”交替出现，可能有重复字母。预计耗时不超过1分钟。
            </p>
    
            <input id="button" style="width: 150px; height:50px; background-color:lightcyan; font-size: 22;" type="button"
             value="Go!" onclick="rungame();">
            <br>
            <br>
            <table align="center" cellspacing="0px"  style="border-color: black; border-collapse: collapse; border: 0px solid #000">
                <tr>
                    <td id="current" rowspan = "2" style="width: 400px; height: 300px; font-size: 150; text-align: center; color:black;
                     border: 3px solid #000">...</td>
                    <td style = "width: 200px; height: 100px; text-align: left; font-size: 20; vertical-align: bottom; border: none;">即将出现：</td>
                </tr>
                <tr>
                    <td id="next" style ="width: 200px; height: 200px; font-size: 70; text-align: center; border: 3px solid #000">...</td>
                </tr>
            </table>
            <h2 id="result" style="color:tomato"></h2>
            <br><br><hr>
    
            <div style="background-color: rgba(255,255,255,0.8); right:0; width:100%; bottom: 0; position: fixed;">
                <h3 id="footer" align="center">----------------------------- =￣ω￣=今天也要加油鸭! -----------------------------</h3>
                <p align="right" ></p>
            </div>
        </div>
    
    </body>
    
    <script>
        var tapped_times = 0;
        document.onkeyup = function(event){
            var tap_f = event || window.event || arguments.callee.caller.arguments[0];
            if(tapped_times < 29 && tap_f && tap_f.keyCode == 70){  //加载进度条，一共按29次f
                tapped_times++;
                var progress_cell = document.getElementById("progress" + tapped_times);
                console.log(tapped_times);
                progress_cell.style.background="#000";
                var loading_perctage = document.getElementById("loading_perctage");
                var loading_perctage_number = tapped_times * 100 / 29;
                loading_perctage.innerHTML = "Loading: "+ loading_perctage_number.toFixed(2) + "%";
                if(tapped_times == 29){ //出现正式游戏部分
                    loading_perctage.innerHTML = "100%";
                    var game = document.getElementById("game");
                    game.style.display = "block";
                    var title_1 = document.getElementById("title_1");
                    title_1.innerHTML = "小热身：q(≧▽≦)多谢，继续向下看吧";
                    console.log("Loading complete.");
                }
            }
        }
        async function rungame(){   //开始游戏
            var button = document.getElementById("button");
            button.style.color = "tomato";
            button.value = "Running!";
            button.disabled = "true";
            var next = document.getElementById("next");
            next.innerHTML = random_alpha();
            var count_down = document.getElementById("current");
            for (i = 3; i > 0; i--){    //倒计时3s
                count_down.innerHTML = i;
                await sleep(1000);
            }
            circle(next);
        }
    
        function sleep(ms){
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    
        function endgame(status, speed ,tap ,current){ //结束游戏
            console.log("Stop. Status =", status);
            result = document.getElementById("result");
            var reason;
            switch(status){ //判断原因
                case "0": reason = "未检测到击键。";
                break;
                case "2": if(tap > 64 && tap < 91){
                    reason = "击键错误，你按了"+String.fromCharCode(tap)+"而非"+current+"。";
                }else{
                    reason = "按下了非字母。";
                }
                break;
            }
            speed = speed / 1000;
            result.innerHTML = "停止原因：" + reason + "完成！你达到了 " + speed.toFixed(3) + "s 一个字母的速度。";
            var button = document.getElementById("button");
            button.style.color = "black";
            button.value = "再试一次";
            button.disabled = false;
            var current = document.getElementById("current");
            current.style.color = "black";
            current.innerHTML = "...";
            var next = document.getElementById("next");
            next.style.color = "black";
            next.innerHTML = "...";
            var footer = document.getElementById("footer");
            footer.innerHTML = "----------------------------- " + random_courage() + " -----------------------------";
        }
    
        async function circle(next){    //游戏循环主体
            for(var i = 1000; i >= 500; i = i - 5){ //速度非线性增加
                    status = 0;
                    var speed = -50 * Math.sqrt((1000 - i) / 5) + 800;
                    current = document.getElementById("current");
                    if (i % 2 == 0){    //改变字母颜色
                        current.style.color = "gray";
                    }else{
                        current.style.color = "black";
                    }
                    current.innerHTML = next.innerHTML;
                    next.innerHTML = random_alpha();
                    console.log("Current speed: " + speed, "Key to be tapped: " + current.innerHTML);
                    wait(speed);    //等待击键
                    var tap = null;
                    document.onkeydown = function(event){
                        tap = event || window.event || arguments.callee.caller.arguments[0];
                    }
                    await sleep(speed); //等待判断
                    var tap_code;
                    if(tap != null){
                            tap_code = tap.keyCode;
                            status = 2;
                        console.log("Comparing: " + tap.keyCode, current.innerHTML.charCodeAt());
                    }
                    if(status != 1){
                        break;
                    }
            }
            endgame(status, speed, tap_code, current.innerHTML);
        }
    
        async function wait(ms){ //sleep放在函数里再间接调用才能实现等待击键
            await sleep(ms);
        }   //直接调用sleep等待期间无法获得击键事件
    
        function random_alpha(){    //随机字母生成
            var arr = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
            var alpha = arr[Math.floor(Math.random()*26)];
            console.log("Producing: " + alpha);
            return alpha;
        }
    
        function random_courage(){  //随机问候语
            var arr = ['(。・ω・。)你认真的样子真好看', 'o(〃＾▽＾〃)o再试一次，肯定会更好!','(￣﹃￣)明明实力超强，却总是装弱', 
            '=￣ω￣=反正我不会烦，你可以多玩一会', 'L(￣︶￣*))L请不要随意调戏我哦', '(╯▽╰ )你体验过巅峰的速度吗?', 'o(￣▽￣)ｄ每日一遍，抑郁再见', 
            '(￣o￣) . z Z', '(>＾－＾)>你觉得单身有助于提升手速吗?', '=￣ω￣=今天也要加油鸭!']
            var courage = arr[Math.floor(Math.random()*9)];
            return courage;
        }
    </script>
    
    </html>